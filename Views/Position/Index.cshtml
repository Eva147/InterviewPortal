@model List<InterviewPortal.Models.Position>
@{
    ViewBag.Title = "Manage Positions";
    var allTopics = ViewBag.AllTopics as List<InterviewPortal.Models.Topic>;
}

<h2 class="mb-4">Manage Positions</h2>

@if (TempData["Message"] != null)
{
    <div class="alert alert-success">@TempData["Message"]</div>
}

<!-- Create Position Button -->
<button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#createPositionModal">Add Position</button>

<!-- Create Topic Button -->
<button class="btn btn-secondary mb-3 ms-2" data-bs-toggle="modal" data-bs-target="#createTopicModal">Add Topic</button>

@foreach (var position in Model)
{
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <h4 class="card-title">@position.Name</h4>

            <button class="btn btn-sm btn-outline-primary mb-2" data-bs-toggle="modal" data-bs-target="#editPositionModal_@position.Id">Edit Position</button>

            <h5>Topics:</h5>
            @foreach (var pt in position.PositionTopics)
            {
                <div class="border p-2 mb-2">
                    <strong>@pt.Topic.Name</strong>
                    <button class="btn btn-sm btn-link text-decoration-none" data-bs-toggle="modal" data-bs-target="#editTopicModal_@pt.Topic.Id">Edit</button>

                    <ul>
                        @foreach (var q in pt.Topic.Questions)
                        {
                            <li>
                                <strong>Q:</strong> @q.QuestionText
                                <ul>
                                    @foreach (var a in q.Answers)
                                    {
                                        <li><strong>A:</strong> @a.AnswerText</li>
                                    }
                                </ul>
                            </li>
                        }
                    </ul>
                </div>
            }
        </div>
    </div>

    <!-- Edit Position Modal -->
    <div class="modal fade" id="editPositionModal_@position.Id" tabindex="-1" aria-labelledby="editPositionLabel_@position.Id" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form asp-action="EditPosition" method="post">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Position - @position.Name</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="id" value="@position.Id" />
                        <div class="mb-3">
                            <label class="form-label">Name</label>
                            <input class="form-control" name="Name" value="@position.Name" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Topics</label>
                            @foreach (var topic in allTopics)
                            {
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="Topics" value="@topic.Id"
                                    @(position.PositionTopics.Any(pt => pt.TopicId == topic.Id) ? "checked" : "") />
                                    <label class="form-check-label">@topic.Name</label>
                                </div>
                            }
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" type="submit">Save</button>
                        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

<!-- Create Position Modal -->
<div class="modal fade" id="createPositionModal" tabindex="-1" aria-labelledby="createPositionLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="CreatePosition" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Position</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Position Name</label>
                        <input class="form-control" name="Name" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Select Topics</label>
                        @foreach (var topic in allTopics)
                        {
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="Topics" value="@topic.Id" />
                                <label class="form-check-label">@topic.Name</label>
                            </div>
                        }
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success" type="submit">Create</button>
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Create Topic Modal -->
<div class="modal fade" id="createTopicModal" tabindex="-1" aria-labelledby="createTopicLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form asp-action="CreateTopic" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Topic</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label>Topic Name</label>
                        <input class="form-control" name="Name" required />
                    </div>
                    <div id="questionContainer">
                        <div class="question-block border p-2 mb-2">
                            <label>Question:</label>
                            <input class="form-control mb-2" name="Questions[0]" />
                            <label>Answers:</label>
                            <input class="form-control mb-1" name="Answers[0][0]" />
                        </div>
                    </div>
                    <button type="button" class="btn btn-outline-secondary" onclick="addQuestion()">+ Add Question</button>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-success" type="submit">Create Topic</button>
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Topic Modals -->
@foreach (var topic in allTopics)
{
    <div class="modal fade" id="editTopicModal_@topic.Id" tabindex="-1" aria-labelledby="editTopicLabel_@topic.Id" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form asp-action="EditTopic" method="post">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Topic - @topic.Name</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="id" value="@topic.Id" />
                        <div class="mb-3">
                            <label>Topic Name</label>
                            <input class="form-control" name="Name" value="@topic.Name" required />
                        </div>
                        @foreach (var question in topic.Questions)
                        {
                            <div class="question-block border p-2 mb-3">
                                <input type="hidden" name="Questions[@question.Id]" value="@question.QuestionText" />
                                <label>Question:</label>
                                <input class="form-control mb-2" name="Questions[@question.Id]" value="@question.QuestionText" />


                                <label>Answers:</label>
                                @foreach (var answer in question.Answers)
                                {
                                    <div class="input-group mb-1">
                                        <input class="form-control" name="Answers[@answer.Id]" value="@answer.AnswerText" />
                                    </div>
                                }
                            </div>
                        }
                        <hr />
                        <h5>Add New Question</h5>
                        <input class="form-control mb-2" name="NewQuestion" />
                        <h6>Add Answer to Existing Question</h6>
                        <select class="form-select mb-2" name="NewAnswerQuestionId">
                            <option value="">-- Select Question --</option>
                            @foreach (var question in topic.Questions)
                            {
                                <option value="@question.Id">@question.QuestionText</option>
                            }
                        </select>
                        <input class="form-control mb-2" name="NewAnswerText" placeholder="New Answer Text" />
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" type="submit">Save</button>
                        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        let questionIndex = 0;

        function addQuestion() {
            questionIndex++;
            const container = document.getElementById("questionContainer");
            const block = document.createElement("div");
            block.className = "question-block border p-2 mb-2";
            block.innerHTML = `
                <label>Question:</label>
                <input class="form-control mb-2" name="Questions[${questionIndex}]" />
                <label>Answers:</label>
                <div id="answersContainer_${questionIndex}">
                    <input class="form-control mb-1" name="Answers[${questionIndex}][0]" />
                </div>
                <button type="button" class="btn btn-sm btn-outline-secondary mt-1" onclick="addAnswer(${questionIndex})">+ Add Answer</button>
            `;
            container.appendChild(block);
        }

        function addAnswer(questionId) {
            const container = document.getElementById(`answersContainer_${questionId}`);
            const answerIndex = container.children.length;
            const input = document.createElement("input");
            input.className = "form-control mb-1";
            input.name = `Answers[${questionId}][${answerIndex}]`;
            container.appendChild(input);
        }

        // Reset the modal to its initial state when closed
        document.getElementById("createTopicModal").addEventListener("hidden.bs.modal", function () {
            const container = document.getElementById("questionContainer");
            container.innerHTML = `
                <div class="question-block border p-2 mb-2">
                    <label>Question:</label>
                    <input class="form-control mb-2" name="Questions[0]" />
                    <label>Answers:</label>
                    <div id="answersContainer_0">
                        <input class="form-control mb-1" name="Answers[0][0]" />
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-secondary mt-1" onclick="addAnswer(0)">+ Add Answer</button>
                </div>
            `;
            questionIndex = 0;
        });

    </script>
}
