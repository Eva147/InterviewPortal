@model IEnumerable<InterviewPortal.Models.Position>
@using Microsoft.AspNetCore.Identity
@inject SignInManager<User> SignInManager
@inject UserManager<User> UserManager

@section Styles {
    <link rel="stylesheet" href="~/css/admin-dashboard.css" />
}

@{
    ViewData["Title"] = "Positions";
}

<h2 class="mb-4">Available Positions</h2>

@if (TempData["Message"] != null)
{
    <div class="alert alert-success">@TempData["Message"]</div>
}

<!-- Positions Table -->
<div class="container">

    <div>
        <button class="btn btn-success add-button" data-bs-toggle="modal" data-bs-target="#addModal">
            Add New Position
        </button>

        <div class="modal fade" id="addModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add Position</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form asp-action="Create" method="post">
                            <div class="mb-3">
                                <label for="positionName" class="form-label">Position Name</label>
                                <input type="text" class="form-control" name="Name" required>
                            </div>
                            <div class="mb-3">
                                <label for="Topics" class="form-label">Select Topics</label>
                                <select multiple class="form-select" name="Topics">
                                    @foreach (var topic in Model.SelectMany(p => p.PositionTopics).Select(pt => pt.Topic).Distinct())
                                    {
                                        <option value="@topic.Id">@topic.Name</option>
                                    }
                                </select>
                            </div>
                            <button type="submit" class="btn btn-success">Add Position</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>Position</th>
                <th>Topics</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var position in Model.Distinct())
            {
                <tr>
                    <td>@position.Name</td>
                    <td>
                        @foreach (var topic in position.PositionTopics.Select(pt => pt.Topic).Distinct())
                        {
                            <p>@topic.Name</p>
                        }
                    </td>
                    <td>
                        @(position.IsActive ? "Active" : "Inactive")
                    </td>
                    <td>
                        <div class="actions">
                            <!-- Edit Button -->
                            <button class="button btn-edit" data-bs-toggle="modal" data-bs-target="#editModal-@position.Id">
                                Edit
                            </button>

                            <!-- Delete Button -->
                            <button class="button btn-delete" data-bs-toggle="modal" data-bs-target="#deleteModal-@position.Id">
                                Delete
                            </button>
                        </div>
                    </td>
                </tr>

                <!-- Edit Position Modal -->
                <div class="modal fade" id="editModal-@position.Id" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Edit Position</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form asp-action="Edit" method="post">
                                    <input type="hidden" name="Id" value="@position.Id" />
                                    <div class="mb-3">
                                        <label for="positionName" class="form-label">Position Name</label>
                                        <input type="text" class="form-control" name="Name" value="@position.Name" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="Topics" class="form-label">Select Topics</label>
                                        <select multiple class="form-select" name="Topics">
                                            @foreach (var topic in ViewBag.AllTopics)
                                            {
                                                var isSelected = position.PositionTopics.Any(pt => pt.TopicId == topic.Id);
                                                <option value="@topic.Id" selected="@isSelected">@topic.Name</option>
                                            }
                                        </select>
                                    </div>
                                    <button type="submit" class="btn btn-success">Save Changes</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Delete Confirmation Modal -->
                <div class="modal fade" id="deleteModal-@position.Id" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Confirm Delete</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p>Are you sure you want to delete <strong>@position.Name</strong>?</p>
                            </div>
                            <div class="modal-footer">
                                <!-- Form to delete the position -->
                                <form asp-action="Delete" method="post">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="@position.Id" />
                                    <button type="submit" class="btn btn-danger">Delete</button>
                                </form>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </tbody>
    </table>
</div>